[[extend 'layout.html']]

<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <a class="nav-link" href="[[=URL('index')]]">Home</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="[[=URL('feature_identifier')]]">Distinct Feature Identifier</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="[[=URL('sample_generator')]]">Sample Generator</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="[[=URL('canvas_editor')]]">Canvas Editor</a>
    </li>
    <li class="nav-item">
        <a class="nav-link active" href="[[=URL('receipt_scanner')]]">Receipt Scanner</a>
    </li>
</ul>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header">Scan Receipt</div>
            <div class="card-body">
                <form action="[[=URL('receipt_scanner')]]" method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">Upload Receipt Image</label>
                        <input type="file" name="image" class="form-control" accept=".jpg,.jpeg,.png,.webp">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Scan Receipt</button>
                </form>
                
                <hr>
                
                <div class="d-grid gap-2">
                    <form action="[[=URL('populate_receipts')]]" method="POST">
                         <button type="submit" class="btn btn-outline-success w-100">Generate Sample Receipts</button>
                    </form>
                </div>
                <div class="form-text mt-2 text-center">Generates mock receipts from SampleStore.</div>
            </div>
        </div>

        [[if history:]]
        <div class="card">
            <div class="card-header">Scan History</div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div class="list-group list-group-flush">
                    [[for item in history:]]
                    <a href="[[=URL('receipt_scanner')]]?sample=[[=item['image_filename']]]" 
                       class="list-group-item list-group-item-action [[='active' if chosen_file == item['image_filename'] else '']]">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 text-truncate" style="max-width: 150px;">[[=item.get('image_filename')]]</h6>
                            <small>[[='${:.2f}'.format(item.get('total')) if isinstance(item.get('total'), (int, float)) else item.get('total')]]</small>
                        </div>
                        <p class="mb-1 small">
                            [[if item.get('is_sample'):]]
                            <span class="badge bg-success">Sample</span>
                            [[else:]]
                            <span class="badge bg-secondary">Upload</span>
                            [[pass]]
                        </p>
                    </a>
                    [[pass]]
                </div>
            </div>
        </div>
        [[pass]]
    </div>

    <div class="col-md-8">
        [[if error:]]
        <div class="alert alert-danger">[[=error]]</div>
        [[pass]]

        [[if results:]]
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">Receipt Image</div>
                    <div class="card-body text-center bg-light">
                        <img src="[[=image_url]]" class="img-fluid border shadow-sm" style="max-height: 500px;">
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">Parsed Data</div>
                    <div class="card-body">
                        [[if 'error' in results:]]
                        <div class="alert alert-warning">
                            <h5 class="alert-heading">Scan Failed</h5>
                            <p>[[=results['error']]]</p>
                        </div>
                        [[else:]]
                        <div class="text-center mb-4">
                            <h4>[[=results.get('store', 'Unknown Store')]]</h4>
                            <p class="text-muted">[[=results.get('date', '')]]</p>
                        </div>
                        
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th class="text-end">Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                [[for item in results.get('items', []):]]
                                <tr>
                                    <td>[[=item['description']]]</td>
                                    <td class="text-end">$[[=f"{item['price']:.2f}"]]</td>
                                </tr>
                                [[pass]]
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td class="fw-bold">Subtotal</td>
                                    <td class="text-end">$[[=f"{results.get('subtotal', 0):.2f}"]]</td>
                                </tr>
                                <tr>
                                    <td>Tax</td>
                                    <td class="text-end">$[[=f"{results.get('tax', 0):.2f}"]]</td>
                                </tr>
                                <tr class="table-dark">
                                    <td>Total</td>
                                    <td class="text-end">$[[=f"{results.get('total', 0):.2f}"]]</td>
                                </tr>
                            </tfoot>
                        </table>
                        [[pass]]
                    </div>
                </div>
            </div>
        </div>
        [[elif chosen_file:]]
         <div class="card mb-4">
            <div class="card-header">Receipt Image</div>
            <div class="card-body text-center bg-light">
                <img src="[[=image_url]]" class="img-fluid border shadow-sm" style="max-height: 500px;">
                <div class="mt-3">
                    <form action="[[=URL('receipt_scanner')]]" method="POST">
                        <input type="hidden" name="chosen_file" value="[[=chosen_file]]">
                        <button type="submit" class="btn btn-primary">Process This Receipt</button>
                    </form>
                </div>
            </div>
        </div>
        [[else:]]
        <div class="alert alert-info text-center py-5">
            <h4>No Receipt Selected</h4>
            <p>Upload a receipt image or generate sample receipts to get started.</p>
        </div>
        [[pass]]
    </div>
</div>
